name: Update WSJ RSS

# 每 15 分钟抓一次，也可以手动触发
on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出仓库
      - uses: actions/checkout@v4

      # 2. 拉取 Google News RSS（WSJ 中文）
      - name: Fetch Google News RSS
        run: |
          curl -L "https://news.google.com/rss/search?q=site:cn.wsj.com&hl=zh-CN&gl=CN&ceid=CN:zh-Hans" -o source.xml

      # 3. 确保 docs 目录存在
      - name: Ensure docs directory
        run: mkdir -p docs

      # 4. 生成干净 RSS（标题+链接）
      - name: Generate Clean RSS
        run: |
          python3 <<EOF
          import xml.etree.ElementTree as ET

          # 解析源 RSS
          tree = ET.parse("source.xml")
          root = tree.getroot()
          channel = root.find("channel")
          items = channel.findall("item")

          # 新建 RSS
          rss = ET.Element("rss", version="2.0")
          new_channel = ET.SubElement(rss, "channel")
          ET.SubElement(new_channel, "title").text = "WSJ 中文 - Clean Feed"
          ET.SubElement(new_channel, "link").text = "https://cn.wsj.com/"
          ET.SubElement(new_channel, "description").text = "WSJ 中文最新文章（标题+链接）"

          # 遍历前 30 条
          for item in items[:30]:
              title = item.find("title").text
              link = item.find("link").text

              new_item = ET.SubElement(new_channel, "item")
              ET.SubElement(new_item, "title").text = title
              ET.SubElement(new_item, "link").text = link
              ET.SubElement(new_item, "guid").text = link

          # 保存到 docs/wsj.xml
          tree = ET.ElementTree(rss)
          tree.write("docs/wsj.xml", encoding="utf-8", xml_declaration=True)
          EOF

      # 5. 提交并推送
      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/wsj.xml
          git commit -m "Update RSS" || echo "No changes"
          git push
