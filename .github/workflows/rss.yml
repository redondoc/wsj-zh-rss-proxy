name: Fetch WSJ RSS

on:
  schedule:
    - cron: "*/15 * * * *"  # 每 15 分钟抓取一次
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Fetch latest WSJ headlines
        run: |
          # 抓取首页最新文章链接
          curl -s -A "Mozilla/5.0" https://cn.wsj.com/ | \
          grep -oP '<a class="WSJTheme--headline.*?href="\K[^"]+' | \
          head -n 10 > latest_links.txt

          # 生成 RSS 文件
          echo '<?xml version="1.0" encoding="UTF-8" ?>' > rss.xml
          echo '<rss version="2.0"><channel>' >> rss.xml
          echo '<title>WSJ 中文网 RSS</title>' >> rss.xml
          echo '<link>https://cn.wsj.com/</link>' >> rss.xml
          echo '<description>WSJ 中文网最新文章标题</description>' >> rss.xml

          while read url; do
            title=$(curl -s $url | grep -oP '<title>\K.*?(?=</title>)' | head -n1)
            echo '<item>' >> rss.xml
            echo "<title>$title</title>" >> rss.xml
            echo "<link>$url</link>" >> rss.xml
            echo '</item>' >> rss.xml
          done < latest_links.txt

          echo '</channel></rss>' >> rss.xml

      - name: Commit if changed
        run: |
          git config --global user.name "rss-bot"
          git config --global user.email "rss-bot@example.com"
          git add rss.xml
          git diff --quiet && git diff --staged --quiet || git commit -m "Update RSS"
          git push
